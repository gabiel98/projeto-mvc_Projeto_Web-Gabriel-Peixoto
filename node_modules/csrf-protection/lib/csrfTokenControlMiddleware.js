const crypto = require('crypto');
const algorithm = 'aes-256-cbc';

const csrfTokenControlMiddleware = function(key, iv, guid) {
	return (req, res, next) => {
		try {
			const clientCSRFToken = req.body._csrf || req.headers['x-csrf-token'] || null;;
			
			//const hash = crypto.createHash('sha256');
		    //hash.update(clientCSRFToken);
			//const hashVal = hash.digest().toString('hex').slice(0, 32);

			// const csrfTokenName = 'CSRF-TOKEN-' + hashVal;
			const csrfTokenName = 'CSRF-TOKEN';
			const decipher = crypto.createDecipheriv(algorithm, Buffer.from(key), iv);	
			let decipherGuid = decipher.update(req.cookies[csrfTokenName], 'hex', 'utf-8');
			decipherGuid += decipher.final('utf-8');

			if (decipherGuid !== clientCSRFToken) {
			  return res.status(403).send("Error! It's forbidden");
			}
			
			next();
				
		} catch(ex) {
			return res.status(403).send("Error! It's forbidden");
		}
	
	};
}
 

module.exports = (key, iv, guid) => csrfTokenControlMiddleware(key, iv, guid);