const crypto = require('crypto');
const algorithm = 'aes-256-cbc';

const csrfTokenMiddleware = function (key, iv, guid) {
	return (req, res, next) => {
		try {
		  const guidKey = crypto.randomBytes(24).toString('hex');
		  const cipher = crypto.createCipheriv(algorithm, Buffer.from(key), iv);
		  let cipherGuid = cipher.update(guidKey, 'utf-8', 'hex');
		  cipherGuid += cipher.final('hex');
		  
		  // const hash = crypto.createHash('sha256');
		  // hash.update(guidKey);
		  // const hashVal = hash.digest().toString('hex').slice(0, 32);
		  
		  // const csrfTokenName = 'CSRF-TOKEN-' + hashVal;
		  const csrfTokenName = 'CSRF-TOKEN';
		  
		  res.cookie(csrfTokenName, cipherGuid, { httpOnly: true, sameSite: 'Strict' });
		  res.locals.csrfToken = guidKey;
		  
		  next();
			
		} catch(ex) {
			res.status(500).send("Error! Necessary Middlewares Not Found");
		}
	};
}	

module.exports = (key, iv, guid) => csrfTokenMiddleware(key, iv, guid);